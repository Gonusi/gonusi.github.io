<html>
	<head>
		<link href="/css/main.css" rel="stylesheet" />
		<link href="/css/prism-theme-retro.css" rel="stylesheet" />
		<title>Track view duration of fake social network feed items using intersection observer. Part 1. · TODO</title>
		<meta name="description" content="A part of a series where we create a photo feed, and track the view duration of each item, displaying results in a real time dashboard. Should look cool, and show me my favorite pics."/>
	</head>
	<body>
		<header class="header">
			<div class="blogInfo">
				<div class="logo">Kasparas Anusauskas</div>
				<div class="about">Personal development notes and experiments</div>
			</div>
			<nav class="nav">
				<ul class="navList">
					<li>
						<a href="/"> Home </a>
					</li>
					<li>
						<a href="/about">About</a>
					</li>
				</ul>
			</nav>
		</header>
		<main class="wrapper">
			<h1>Track view duration of fake social network feed items using intersection observer. Part 1.</h1>
			<h2>What we're gonna Build</h2>
<p>** Weekly challenge is for experiments, I reserve up to 7 hours from my week for those, including writing the blog. So there might be unfinished business below. You have been warned. **</p>
<p>Social networks and websites often have feeds where you scroll through content items. It's then common sense they would measure the view duration of each piece. This would greatly help in serving even more &quot;similarly engaging, intelligence-stimulating content&quot;, because that's what we like to see, right? I've recently seen a movie, (The social dilemma)[https://www.google.com/search?q=imdb+the+social+dilemma] which talks about this stuff a lot. I don't agree with the narrative it makes social networks &quot;evil&quot;, but I still enjoyjed it.</p>
<p>Let's build a feed of nice images and measure ourselves to see how the whole tracking thing can be built easily, and how the results look, real time.</p>
<h2>The app</h2>
<p>Nothing takes away the fun better than a good, detailed plan. Let's use React, and build these components:</p>
<ul>
<li>ViewDurationTracker - renders content, fires callback passed from parent with view duration when it changes;</li>
<li>Feed - assembles a categorized, pseudo-randomized list of nice photos, and passes them down using props to any component it is supplied;</li>
<li>Dashboard - displays list of most popular content, and view duration</li>
<li>Controller - listens for callbacks with view duration for all items, can pass data to another component (dashboard)</li>
</ul>
<p>I will not present all the code here, as the experiments do get a bit complex. Feel free to check it on (github)[https://github.com/Gonusi/in-browser-view-duration-tracking-using-intersection-observer] or run it on (codesandbox)[https://codesandbox.io/s/in-browser-feed-item-view-duration-tracking-using-intersection-observer-zxgi7] which you will also find embedded on the bottom of this post.</p>
<p>Let's discuss key parts and view the result.</p>
<h3>ViewDurationTracker - the main element enabling us to very easily time the view</h3>
<p>To build this stuff, first I had to put down some ground rules.</p>
<p>On Instagram, when looking at a photo, I sometimes scroll it out of the viewport so my fingers don't obstruct the view. So, I'll say that when <strong>85% of an element is in the viewport, we'll consider it &quot;being viewed&quot;</strong>.</p>
<p><em>Obviously this is greatly simplified, and there is probably a whole branch of analytics just for getting the various &quot;in view&quot; factors right - but 85% is gonna work fine for our 7 hours of alloted time :)</em></p>
<p>Let's explore the components responsibilities in more detail:</p>
<ul>
<li>render children in a div;</li>
<li>when 85% enters viewport, save the <code>lastEntryDate</code> in state;</li>
<li>when 85% leaves the viewport, calculate view duration as difference between <code>Date.now()</code> and <code>lastEntryDate</code>;</li>
<li>call callback passed from parent as a prop with view view duration and some info about the element.</li>
</ul>
<p>Simple stuff. Yet when I tried to <em>test-driven-develop-it</em> I found testing it is not possible using regular <a href="https://jestjs.io/">Jest</a> / <a href="https://testing-library.com/docs/react-testing-library/intro/">React testing library</a> / <a href="https://github.com/jsdom/jsdom">jsdom</a> setup, because <em>jsdom does not support real layout, making us unable to test logic based on scroll position</em>.</p>
<p>Fortunately, we now have <a href="https://www.cypress.io/">Cypress</a> which renders tests in a real browser. Lately, it can even render react components for unit testing without having any kind of &quot;app&quot;. I'll make sure to write about it later.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// To run:</span><br><span class="token comment">// npx cypress open-ct</span><br><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@cypress/react"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> ViewDurationTracker <span class="token keyword">from</span> <span class="token string">"./ViewDurationTracker"</span><span class="token punctuation">;</span><br><br><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  cy<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">320</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"renders children inside a div"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">mount</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>ViewDurationTracker<span class="token operator">></span><span class="token constant">I</span> am a single child<span class="token operator">&lt;</span><span class="token operator">/</span>ViewDurationTracker<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"[data-cy=TimedViewContainer]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"I am a single child"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"calls callback passing correct arguments"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// I know I know. But cy.spy() only accepts [object, property] - let's keep it simple and refactor later if we have time. </span><br>  window<span class="token punctuation">.</span><span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> viewDuration<span class="token punctuation">,</span> properties <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span>viewDuration<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">greaterThan</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// Expect 200ms view duration, but allow up to 250ms </span><br>    <span class="token comment">// The programattic scrolling part consumes a few ms so we're adjusting for taht</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span>viewDuration<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">lessThan</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  cy<span class="token punctuation">.</span><span class="token function">spy</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token string">"callback"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"callback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">mount</span><span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div <span class="token parameter">style</span><span class="token operator">=></span><br>      <span class="token operator">&lt;</span>ViewDurationTracker onViewDurationMsChange<span class="token operator">=</span><span class="token punctuation">{</span>callback<span class="token punctuation">}</span> <span class="token parameter">properties</span><span class="token operator">=></span><br>        <span class="token constant">I</span> am a single child<br>      <span class="token operator">&lt;</span><span class="token operator">/</span>ViewDurationTracker<span class="token operator">></span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// At this point we're in a real browser, on the top of the viewport</span><br>  cy<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token string">"bottom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// We've now scrolled ±10000px down</span><br>  cy<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// After waiting a 200ms we scroll back up</span><br>  cy<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token string">"top"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// And we check that our callback was called.</span><br>  <span class="token comment">// Callback above contains more checks</span><br>  cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"@callback"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">"have.been.called"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Possibly the more "Cypress'y" way to do this for reference (but I don't like it):</span><br>  <span class="token comment">// cy.get("@callback").should(</span><br>  <span class="token comment">//  "have.been.calledWithMatch",</span><br>  <span class="token comment">//  Cypress.sinon.match.number</span><br>  <span class="token comment">//    .and(Cypress.sinon.match((x) => x > 100, "> 100"))</span><br>  <span class="token comment">//    .and(Cypress.sinon.match((x) => x &lt; 150, "&lt; 150"))</span><br>  <span class="token comment">// );</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And that's the test. I was blown away by comparing:</p>
<ul>
<li>my thoughts on how much trouble it is gonna be to write it</li>
<li>how little trouble it actually was</li>
</ul>
<p>After having the test, the component itself was very easy too. We're building on the shoulder of giants people, and using the (Intersection Observer API)[https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API].</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span> lastEntryTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> viewDuration<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// Using reducer because my 3 simple rules of determining "will you get fucked up by the functional component" say I indeed will:</span><br><span class="token comment">// - Does it pass a callback to some function? // true</span><br><span class="token comment">// - Does the callback modify state ? // true</span><br><span class="token comment">// - Does the state modification relies on previous state? // true</span><br><span class="token comment">// When all 3 are true, you will have stale state problems due to JS closures, just manage the state in a reducer like this to avoid it.</span><br><span class="token comment">// The callback only dispatches actions, and does not need to know anything about the state, avoiding problems entirely</span><br><span class="token comment">// If in doubt, read the excellent article about it here. Read it all, and read it at least 3 times:</span><br><span class="token comment">// https://overreacted.io/a-complete-guide-to-useeffect/</span><br><span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">case</span> <span class="token string">"enterViewport"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> lastEntryTime<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">case</span> <span class="token string">"leaveViewport"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        <span class="token operator">...</span>state<span class="token punctuation">,</span><br>        viewDuration<span class="token operator">:</span> state<span class="token punctuation">.</span>lastEntryTime<br>          <span class="token operator">?</span> state<span class="token punctuation">.</span>viewDuration <span class="token operator">+</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> state<span class="token punctuation">.</span>lastEntryTime<span class="token punctuation">)</span><br>          <span class="token operator">:</span> <span class="token number">0</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> state<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">ViewDurationTracker</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span><br>  children<span class="token punctuation">,</span><br>  properties<span class="token punctuation">,</span><br>  onViewDurationMsChange<span class="token punctuation">,</span><br>  <span class="token operator">...</span>props<br><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> elementRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// This gets called when interesection observer says "85% of element has entered or left the viewport"</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">intersectionCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">entries</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"enterViewport"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"leaveViewport"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// On startup, setup the intersection observer for this component instance</span><br>    <span class="token keyword">let</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>intersectionCallback<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>      threshold<span class="token operator">:</span> <span class="token number">0.85</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>elementRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token comment">// Don't forget to disconnect it when the instance says bye</span><br>      observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>viewDuration<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'VIEW DURATION CHANGE'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>viewDuration<span class="token punctuation">)</span><br>      <span class="token comment">// when view duration of this instance changes, call callback from parent</span><br>      onViewDurationMsChange<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        viewDuration<span class="token operator">:</span> state<span class="token punctuation">.</span>viewDuration<span class="token punctuation">,</span> <span class="token comment">// pass view duration</span><br>        properties <span class="token comment">// pass properties we received from the parent back (it's gonna be {id: xxx} or similar)</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>state<span class="token punctuation">.</span>viewDuration<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div data<span class="token operator">-</span>cy<span class="token operator">=</span><span class="token string">"TimedViewContainer"</span> ref<span class="token operator">=</span><span class="token punctuation">{</span>elementRef<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span><span class="token operator">></span><br>      <span class="token punctuation">{</span>children<span class="token punctuation">}</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> ViewDurationTracker<span class="token punctuation">;</span></code></pre>
<p>At this point, we can  track the duration of a single item. We still need to deploy a swarm of these trackers on a fake &quot;feed&quot; of images, aggregate all their view durations as the user scrolls through and display the data.</p>
<h2>Feed, Dashboard and Controller</h2>
<h3>Fetch photo data using unsplash.com API</h3>
<p>For the experiment, we'll need something to track. Unsplash has a wonderful API allowing us to search fetch a list of image data based on many search criteria. I've assembled a list of such images fetched from multiple categories (see below). Then, transposed the json data a it as to avoid fiddling with the objects during run time.</p>
<p>Here's a (not very nicely built but working) node script:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// to run, install nodejs, name the file "getPhotos.js" and, from the project dir run:</span><br><span class="token comment">// node ./getPhotos.js</span><br><br><span class="token keyword">const</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node-fetch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> unsplash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"unsplash-js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token constant">ACCESS_KEY</span> <span class="token operator">=</span> <span class="token string">"mfpNJ7dKkJlWHZ9NFd6fyBhVSLiFZKC90D0dVN48JIs"</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token constant">UTM_PARAMS</span> <span class="token operator">=</span> <span class="token string">"utm_source=ScrollObserver2&amp;utm_medium=referral"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token constant">CATEGORIES</span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>	<span class="token string">"animals"</span><span class="token punctuation">,</span><br>	<span class="token string">"architecture"</span><span class="token punctuation">,</span><br>	<span class="token string">"cars"</span><span class="token punctuation">,</span><br>	<span class="token string">"fashion"</span><span class="token punctuation">,</span><br>	<span class="token string">"man"</span><span class="token punctuation">,</span><br>	<span class="token string">"motorbikes"</span><span class="token punctuation">,</span><br>	<span class="token string">"nature"</span><span class="token punctuation">,</span><br>	<span class="token string">"sports"</span><span class="token punctuation">,</span><br>	<span class="token string">"street"</span><span class="token punctuation">,</span><br>	<span class="token string">"underwater"</span><span class="token punctuation">,</span><br>	<span class="token string">"woman"</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> api <span class="token operator">=</span> unsplash<span class="token punctuation">.</span><span class="token function">createApi</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>	accessKey<span class="token operator">:</span> <span class="token constant">ACCESS_KEY</span><span class="token punctuation">,</span><br>	fetch<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchPhotoData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">let</span> promises<span class="token punctuation">;</span><br>	<span class="token keyword">try</span> <span class="token punctuation">{</span><br>		promises <span class="token operator">=</span> <span class="token constant">CATEGORIES</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">category</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>			console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Will fetch category </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>category<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>			<span class="token keyword">return</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">getPhotos</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>				orientation<span class="token operator">:</span> <span class="token string">"portrait"</span><span class="token punctuation">,</span><br>				featured<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>				page<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>				perPage<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token comment">// Undocumented max seems to be 30.</span><br>				query<span class="token operator">:</span> category<span class="token punctuation">,</span><br>			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">const</span> responses <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">let</span> idsByCategory <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>	<span class="token keyword">let</span> dataByIds <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>	<span class="token constant">CATEGORIES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">category<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>		<span class="token keyword">let</span> categoryPhotos <span class="token operator">=</span> responses<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>response<span class="token punctuation">.</span>results<span class="token punctuation">;</span><br>		idsByCategory<span class="token punctuation">[</span>category<span class="token punctuation">]</span> <span class="token operator">=</span> categoryPhotos<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> result<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token keyword">let</span> categoryPhotoData <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>categoryPhotos<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> photo</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>			<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><br>				acknowledgeUrl<span class="token operator">:</span> photo<span class="token punctuation">.</span>links<span class="token punctuation">.</span>download_location<span class="token punctuation">,</span><br>				description<span class="token operator">:</span> photo<span class="token punctuation">.</span>description<span class="token punctuation">,</span><br>				id<span class="token operator">:</span> photo<span class="token punctuation">.</span>id<span class="token punctuation">,</span><br>				likes<span class="token operator">:</span> photo<span class="token punctuation">.</span>likes<span class="token punctuation">,</span><br>				src<span class="token operator">:</span> photo<span class="token punctuation">.</span>urls<span class="token punctuation">.</span>regular<span class="token punctuation">,</span><br>				unsplashLink<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://unsplash.com?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">UTM_PARAMS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>				userLink<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>photo<span class="token punctuation">.</span>user<span class="token punctuation">.</span>links<span class="token punctuation">.</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">UTM_PARAMS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>				username<span class="token operator">:</span> photo<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token punctuation">,</span><br>				category<span class="token punctuation">,</span><br>			<span class="token punctuation">}</span><span class="token punctuation">;</span><br>			acc<span class="token punctuation">[</span>photo<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">;</span><br>			<span class="token keyword">return</span> acc<span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		dataByIds <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>dataByIds<span class="token punctuation">,</span> <span class="token operator">...</span>categoryPhotoData <span class="token punctuation">}</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">let</span> categories <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>idsByCategory<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><br>		categories<span class="token punctuation">,</span><br>		idsByCategory<span class="token punctuation">,</span><br>		dataByIds<span class="token punctuation">,</span><br>	<span class="token punctuation">}</span><span class="token punctuation">;</span><br>	fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">"photos.json"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Result:"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"We're done."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">fetchPhotoData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></code></pre>
<h3>Feed</h3>
<p>Using the photo data fetched, building a list is trivial. However, I wanted to add some additional functionality to ensure all categories have an equal chance to be displayed, with a certain level of randomization.</p>
<p>The algorithm should roughly:</p>
<ul>
<li>randomize order of categories;</li>
<li>randomize order of images in each category;</li>
<li>take first image from first category, append to feed;</li>
<li>take first image from second category, append to feed;</li>
<li>...</li>
<li>when categories run out, repeat with the second image;</li>
<li>...</li>
<li>when images run out, stop.</li>
</ul>
<p>This allows us to distribute categories through the list nicely. Later I've discovered a bug (ocassionaly one category is shown multiple times), but had no more time to fix it or to add a test for it, at least in this iteration.</p>
<h3>Dashboard</h3>
<p>Let's build a very simple list of images marked from Top 1 to Top 20, also displaying the view duration in seconds below. Clicking on the image should scroll the feed to that image.
It also should have controls for pausing the tracking.</p>
<h3>Controller</h3>
<p>This one accumulates the view duration of all elements and sorts them. It should be capable of accepting a minimum view duration to track - so that when user scrolls past the list very fast, these images don't get recorded. That, I've found, would only creates noise in our results - user does not actually view these images (unless user is a machine) anyway.</p>
<h2>Results</h2>
<p>It works quite nicely. I've tested the thing multiple times, and yes, if you forget you're being tracked, you get some results you:</p>
<ul>
<li>might not expect;</li>
<li>might expect but still be a bit ashamed of;</li>
<li>might be interested by.</li>
</ul>
<p>I am a ±30 year old male, enjoying enduro motorcycling, so I can pretty much predict what categories I'll spend most time on. It's all very expected, as I am ruled by my prewired human brain. However, this is still very interesting stuff, and for my next experiment I might update the tracker, build it into a chrome plugin so I could check the view duration of any web content. Then I could track facebook feeds etc.</p>
<p>And these feeds are not only photos, it contains political stuff etc. For now, the results are best shown in a video, so enjoy:</p>
<p>Check the full code on (GitHub)[https://github.com/Gonusi/in-browser-view-duration-tracking-using-intersection-observer] or (CodeSandbox[https://codesandbox.io/s/in-browser-feed-item-view-duration-tracking-using-intersection-observer-zxgi7?file=/src/components/ViewDurationTracker/ViewDurationTracker.jsx:0-1643]).</p>
<p>Bye for now, have a great day.
Kasparas</p>

		</main>
		<footer class="footer">
			<div class="about">
				<div><strong>Kasparas Anusauskas</strong></div>
				<a href="https://www.linkedin.com/in/kasparas-anusauskas">LinkedIn</a>
			</div>
		</footer>
	</body>
</html>
