<!DOCTYPE html>
<html lang="en">
	<head>
		<link href="/css/main.css" rel="stylesheet" />
		<link href="/css/prism-theme-retro.css" rel="stylesheet" />
		<title>Track view duration of fake social network feed items using intersection observer. Part 1. · Kasparas Anusauskas</title>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="A part of a series where we create a photo feed, and track the view duration of each item, displaying results in a real time dashboard. Should look cool, and show me my favorite pics." />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link rel="icon" href="/assets/favicon.png" sizes="any" />
		<link rel="apple-touch-icon" href="/assets/favicon.png" />
		<link
			href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,700;0,900;1,400;1,700&family=Lora:ital,wght@0,400;0,500;1,400;1,500"
			rel="stylesheet"
		/>
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-115C9Z6LKN"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());

			gtag("config", "G-115C9Z6LKN");
		</script>
	</head>
	<body>
		<div class="wrapper">
			<header class="header">
				<div class="blogInfo">
					<div class="logo">Kasparas Anusauskas</div>
					<div class="about">Personal development notes and experiments</div>
				</div>
				<nav class="nav">
					<ul class="navList">
						<li>
							<a href="/"> Home </a>
						</li>
						<li>
							<a href="/about">About</a>
						</li>
					</ul>
				</nav>
			</header>
			<main class="content">
				<h1>Track view duration of fake social network feed items using intersection observer. Part 1.</h1>
				<div class="inner"><h2>What we're gonna Build</h2>
<p><strong>Weekly challenge is for experiments, I reserve up to 7 hours from my week for those, including writing the blog. This is not production grade stuff. You have been warned.</strong></p>
<p>Social networks and websites often have feeds where you scroll through content items. It's then common sense they would measure the view duration of each piece. This would greatly help in serving even more &quot;similarly engaging, intelligence-stimulating content&quot;, because that's what we like to see, right? I've recently seen a movie, <a href="https://www.google.com/search?q=imdb+the+social+dilemma">The social dilemma</a> which talks about this stuff a lot. I don't agree with the narrative it makes social networks &quot;evil&quot;, but I still enjoyjed it.</p>
<p>Let's build a feed of nice images and measure ourselves to see how the whole tracking thing can be built easily, and how the results look, real time.</p>
<p>To begin with, feel free to watch this demo of the final app. Or just leave it to the end.</p>
<div class="videoWrapper">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/LjVAYFTzb1I" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>
<h2>The app</h2>
<p>Nothing takes away the fun better than a good, detailed plan. Let's use React, and build these components:</p>
<ul>
<li>ViewDurationTracker - renders content, fires callback passed from parent with view duration when it changes;</li>
<li>Feed - assembles a categorized, pseudo-randomized list of nice photos, and passes them down using props to any component it is supplied;</li>
<li>Dashboard - displays list of most popular content, and view duration</li>
<li>Controller - listens for callbacks with view duration for all items, can pass data to another component (dashboard)</li>
</ul>
<p>I will not present all the code here, as the stuff does get a bit lengthy. Feel free to check it on <a href="https://github.com/Gonusi/in-browser-view-duration-tracking-using-intersection-observer">github</a> or run it on <a href="https://codesandbox.io/s/in-browser-feed-item-view-duration-tracking-using-intersection-observer-zxgi7">codesandbox</a>.</p>
<p>Let's discuss key parts and view the result.</p>
<h3>ViewDurationTracker - the main element enabling us to very easily time the view</h3>
<p>To build this stuff, first I had to put down some ground rules.</p>
<p>On Instagram, when looking at a photo, I sometimes scroll it out of the viewport so my fingers don't obstruct the view. So, I'll say that when <strong>85% of an element is in the viewport, we'll consider it &quot;being viewed&quot;</strong>.</p>
<p><em>Obviously this is greatly simplified, and there is probably a whole branch of analytics just for getting the various &quot;in view&quot; factors right - but 85% is gonna work fine for our 7 hours of alloted time :)</em></p>
<p>Let's explore the components responsibilities in more detail:</p>
<ul>
<li>render children in a div;</li>
<li>when 85% enters viewport, save the <code>lastEntryDate</code> in state;</li>
<li>when 85% leaves the viewport, calculate view duration as difference between <code>Date.now()</code> and <code>lastEntryDate</code>;</li>
<li>call callback passed from parent as a prop with view view duration and some info about the element.</li>
</ul>
<p>Simple stuff. Yet when I tried to <em>test-driven-develop-it</em> I found testing it is not possible using regular <a href="https://jestjs.io/">Jest</a> / <a href="https://testing-library.com/docs/react-testing-library/intro/">React testing library</a> / <a href="https://github.com/jsdom/jsdom">jsdom</a> setup, because <em>jsdom does not support real layout, making us unable to test logic based on scroll position</em>.</p>
<p>Fortunately, we now have <a href="https://www.cypress.io/">Cypress</a> which renders tests in a real browser. Lately, it can even render react components for unit testing without having any kind of &quot;app&quot;. I'll make sure to write about it later.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// To run:</span>
<span class="token comment">// npx cypress open-ct</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@cypress/react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ViewDurationTracker <span class="token keyword">from</span> <span class="token string">"./ViewDurationTracker"</span><span class="token punctuation">;</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  cy<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">320</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"renders children inside a div"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">mount</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>ViewDurationTracker<span class="token operator">></span><span class="token constant">I</span> am a single child<span class="token operator">&lt;</span><span class="token operator">/</span>ViewDurationTracker<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"[data-cy=TimedViewContainer]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"I am a single child"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"calls callback passing correct arguments"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Let's use window and not worry about it for once.</span>
  <span class="token comment">// cy.spy only accepst [object, property] so </span>
  <span class="token comment">// let's not complicate our own lives for now.  </span>
  window<span class="token punctuation">.</span><span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> viewDuration<span class="token punctuation">,</span> properties <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>viewDuration<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">greaterThan</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Expect 200ms view duration, but allow up to 250ms </span>
    <span class="token comment">// The programattic scrolling part consumes a few ms so we're adjusting for taht</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>viewDuration<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">lessThan</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  cy<span class="token punctuation">.</span><span class="token function">spy</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token string">"callback"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"callback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">mount</span><span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">paddingTop</span><span class="token operator">:</span> <span class="token string">"10000px"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>ViewDurationTracker onViewDurationMsChange<span class="token operator">=</span><span class="token punctuation">{</span>callback<span class="token punctuation">}</span> properties<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token constant">I</span> am a single child
      <span class="token operator">&lt;</span><span class="token operator">/</span>ViewDurationTracker<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// At this point we're in a real browser, on the top of the viewport</span>
  cy<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token string">"bottom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// We've now scrolled ±10000px down</span>
  cy<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// After waiting a 200ms we scroll back up</span>
  cy<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token string">"top"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// And we check that our callback was called.</span>
  <span class="token comment">// Callback above contains more checks</span>
  cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"@callback"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">"have.been.called"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Possibly the more "Cypress'y" way to do this for reference:</span>
  <span class="token comment">// (I don't like it):</span>
  <span class="token comment">// cy.get("@callback").should(</span>
  <span class="token comment">//  "have.been.calledWithMatch",</span>
  <span class="token comment">//  Cypress.sinon.match.number</span>
  <span class="token comment">//    .and(Cypress.sinon.match((x) => x > 100, "> 100"))</span>
  <span class="token comment">//    .and(Cypress.sinon.match((x) => x &lt; 150, "&lt; 150"))</span>
  <span class="token comment">// );</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And that's the test. I was blown away by comparing:</p>
<ul>
<li>my thoughts on how much trouble it is gonna be to write it</li>
<li>how little trouble it actually was</li>
</ul>
<p>After having the test, the component itself was very easy too. We're building on the shoulder of giants people, and using the (Intersection Observer API)[https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API].</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">lastEntryTime</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">viewDuration</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Using reducer because my 3 simple rules of determining "will you get f****d</span>
<span class="token comment">// up by the functional component" say I indeed will:</span>
<span class="token comment">// - Does it pass a callback to some function? // true</span>
<span class="token comment">// - Does the callback modify state ? // true</span>
<span class="token comment">// - Does the state modification relies on previous state? // true When all 3</span>
<span class="token comment">//   are true, you will have stale state problems due to JS closures, just</span>
<span class="token comment">//   manage the state in a reducer like this to avoid it. The callback only</span>
<span class="token comment">//   dispatches actions, and does not need to know anything about the state,</span>
<span class="token comment">//   avoiding problems entirely If in doubt, read the excellent article about it</span>
<span class="token comment">//   here. Read it all, and read it at least 3 times:</span>
<span class="token comment">//   https://overreacted.io/a-complete-guide-to-useeffect/</span>
<span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"enterViewport"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> <span class="token literal-property property">lastEntryTime</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">"leaveViewport"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>state<span class="token punctuation">,</span>
        <span class="token literal-property property">viewDuration</span><span class="token operator">:</span> state<span class="token punctuation">.</span>lastEntryTime
          <span class="token operator">?</span> state<span class="token punctuation">.</span>viewDuration <span class="token operator">+</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> state<span class="token punctuation">.</span>lastEntryTime<span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">ViewDurationTracker</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  children<span class="token punctuation">,</span>
  properties<span class="token punctuation">,</span>
  onViewDurationMsChange<span class="token punctuation">,</span>
  <span class="token operator">...</span>props
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> elementRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// This gets called when interesection observer says "85% of element has</span>
  <span class="token comment">// entered or left the viewport"</span>
  <span class="token keyword">const</span> <span class="token function-variable function">intersectionCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">entries</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"enterViewport"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"leaveViewport"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// On startup, setup the intersection observer for this component instance</span>
    <span class="token keyword">let</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>intersectionCallback<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">threshold</span><span class="token operator">:</span> <span class="token number">0.85</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>elementRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// Don't forget to disconnect it when the instance says bye</span>
      observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>viewDuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// when view duration of this instance changes, call callback from parent</span>
      onViewDurationMsChange<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">viewDuration</span><span class="token operator">:</span> state<span class="token punctuation">.</span>viewDuration<span class="token punctuation">,</span> 
        properties <span class="token comment">// might be an {id}, might be anything else...</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>state<span class="token punctuation">.</span>viewDuration<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div data<span class="token operator">-</span>cy<span class="token operator">=</span><span class="token string">"TimedViewContainer"</span> ref<span class="token operator">=</span><span class="token punctuation">{</span>elementRef<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ViewDurationTracker<span class="token punctuation">;</span></code></pre>
<p>At this point, we can  track the duration of a single item. We still need to deploy a swarm of these trackers on a fake &quot;feed&quot; of images, aggregate all their view durations as the user scrolls through and display the data.</p>
<h2>Feed, Dashboard and Controller</h2>
<h3>Fetch photo data using unsplash.com API</h3>
<p>For the experiment, we'll need something to track. Unsplash has a wonderful API allowing us to search fetch a list of image data based on many search criteria. I've assembled a list of such images fetched from multiple categories (see below). Then, transposed the json data a it as to avoid fiddling with the objects during run time.</p>
<p>Here's a node script I scribbled to use the API:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// To run, from script directory:</span>
<span class="token comment">// node ./getPhotos.js</span>

<span class="token keyword">const</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node-fetch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> unsplash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"unsplash-js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">ACCESS_KEY</span> <span class="token operator">=</span> <span class="token string">"mfpNJ7dKkJlWHZ9NFd6fyBhVSLiFZKC90D0dVN48JIs"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">UTM_PARAMS</span> <span class="token operator">=</span> <span class="token string">"utm_source=ScrollObserver2&amp;utm_medium=referral"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">CATEGORIES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token string">"animals"</span><span class="token punctuation">,</span>
	<span class="token string">"architecture"</span><span class="token punctuation">,</span>
	<span class="token string">"cars"</span><span class="token punctuation">,</span>
	<span class="token string">"fashion"</span><span class="token punctuation">,</span>
	<span class="token string">"man"</span><span class="token punctuation">,</span>
	<span class="token string">"motorbikes"</span><span class="token punctuation">,</span>
	<span class="token string">"nature"</span><span class="token punctuation">,</span>
	<span class="token string">"sports"</span><span class="token punctuation">,</span>
	<span class="token string">"street"</span><span class="token punctuation">,</span>
	<span class="token string">"underwater"</span><span class="token punctuation">,</span>
	<span class="token string">"woman"</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> api <span class="token operator">=</span> unsplash<span class="token punctuation">.</span><span class="token function">createApi</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	<span class="token literal-property property">accessKey</span><span class="token operator">:</span> <span class="token constant">ACCESS_KEY</span><span class="token punctuation">,</span>
	fetch<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchPhotoData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> promises<span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		promises <span class="token operator">=</span> <span class="token constant">CATEGORIES</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">category</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Will fetch category </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>category<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">getPhotos</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				<span class="token literal-property property">orientation</span><span class="token operator">:</span> <span class="token string">"portrait"</span><span class="token punctuation">,</span>
				<span class="token literal-property property">featured</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
				<span class="token literal-property property">page</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
				<span class="token literal-property property">perPage</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token comment">// Undocumented max seems to be 30.</span>
				<span class="token literal-property property">query</span><span class="token operator">:</span> category<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">const</span> responses <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> idsByCategory <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> dataByIds <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token constant">CATEGORIES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">category<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
		<span class="token keyword">let</span> categoryPhotos <span class="token operator">=</span> responses<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>response<span class="token punctuation">.</span>results<span class="token punctuation">;</span>
		idsByCategory<span class="token punctuation">[</span>category<span class="token punctuation">]</span> <span class="token operator">=</span> categoryPhotos<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> result<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> categoryPhotoData <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>categoryPhotos<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> photo</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
				<span class="token literal-property property">acknowledgeUrl</span><span class="token operator">:</span> photo<span class="token punctuation">.</span>links<span class="token punctuation">.</span>download_location<span class="token punctuation">,</span>
				<span class="token literal-property property">description</span><span class="token operator">:</span> photo<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
				<span class="token literal-property property">id</span><span class="token operator">:</span> photo<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
				<span class="token literal-property property">likes</span><span class="token operator">:</span> photo<span class="token punctuation">.</span>likes<span class="token punctuation">,</span>
				<span class="token literal-property property">src</span><span class="token operator">:</span> photo<span class="token punctuation">.</span>urls<span class="token punctuation">.</span>regular<span class="token punctuation">,</span>
				<span class="token literal-property property">unsplashLink</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://unsplash.com?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">UTM_PARAMS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
				<span class="token literal-property property">userLink</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>photo<span class="token punctuation">.</span>user<span class="token punctuation">.</span>links<span class="token punctuation">.</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">UTM_PARAMS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
				<span class="token literal-property property">username</span><span class="token operator">:</span> photo<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
				category<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>
			acc<span class="token punctuation">[</span>photo<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
			<span class="token keyword">return</span> acc<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		dataByIds <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>dataByIds<span class="token punctuation">,</span> <span class="token operator">...</span>categoryPhotoData <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> categories <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>idsByCategory<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
		categories<span class="token punctuation">,</span>
		idsByCategory<span class="token punctuation">,</span>
		dataByIds<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">"photos.json"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Result:"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"We're done."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">fetchPhotoData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3>Feed</h3>
<p>Using the photo data fetched, building a list is trivial. However, I wanted to add some additional functionality to ensure all categories have an equal chance to be displayed, with a certain level of randomization.</p>
<p>The algorithm should roughly:</p>
<ul>
<li>randomize order of categories;</li>
<li>randomize order of images in each category;</li>
<li>take first image from first category, append to feed;</li>
<li>take first image from second category, append to feed;</li>
<li>...</li>
<li>when categories run out, repeat with the second image;</li>
<li>...</li>
<li>when images run out, stop.</li>
</ul>
<p>This allows us to distribute categories through the list nicely. Later I've discovered a bug (ocassionaly one category is shown multiple times), but had no more time to fix it or to add a test for it, at least in this iteration.</p>
<p>See the code on:</p>
<ul>
<li>(codesandbox)[https://codesandbox.io/s/in-browser-feed-item-view-duration-tracking-using-intersection-observer-zxgi7?file=/src/componentDemoViews/FeedDemoView.jsx]</li>
<li>(Github)[https://github.com/Gonusi/in-browser-view-duration-tracking-using-intersection-observer/blob/main/src/components/Feed/Feed.jsx]</li>
</ul>
<h3>Controller</h3>
<p>This one accumulates the view duration of all elements and sorts them. It should be capable of accepting a minimum view duration to track - so that when user scrolls past the list very fast, these images don't get recorded. That, I've found, would only creates noise in our results - user does not actually view these images (unless user is a machine) anyway.</p>
<p>So, the plan is:</p>
<ul>
<li>pass a <code>onViewDurationChange</code> callback / handler to the child Feed component;</li>
<li>when it's fired, take the <code>{viewDuration, imageSrc}</code> or similar;</li>
<li>put this data into an object containing list of viewed images;</li>
<li>if such <code>imageSrc</code> already exists in that list, add the <code>viewDuration</code> to the previous `viewDuration;</li>
<li>sort the results based on view duration to form a top 20 list.</li>
</ul>
<p>See the code on:</p>
<ul>
<li><a href="https://codesandbox.io/s/in-browser-feed-item-view-duration-tracking-using-intersection-observer-zxgi7?file=/src/components/Controller/Controller.jsx">codesandbox</a></li>
<li><a href="https://github.com/Gonusi/in-browser-view-duration-tracking-using-intersection-observer/blob/main/src/components/Controller/Controller.jsx">Github</a></li>
</ul>
<h3>Dashboard</h3>
<p>Top 20 images images should be displayed with their respective view duration in seconds at the botttom of the screen. Clicking on an image should scroll the feed to that image so the user can see it better when browsing the results. So, it also should have controls for pausing the tracking.</p>
<p>See the code on:</p>
<ul>
<li><a href="https://codesandbox.io/s/in-browser-feed-item-view-duration-tracking-using-intersection-observer-zxgi7?file=/src/components/Dashboard/Dashboard.jsx">codesandbox</a></li>
<li><a href="https://github.com/Gonusi/in-browser-view-duration-tracking-using-intersection-observer/blob/main/src/components/Dashboard/Dashboard.jsx">Github</a></li>
</ul>
<h2>Results</h2>
<p>It works quite nicely. I've tested the thing multiple times, and yes, if you forget you're being tracked, you get some results you:</p>
<ul>
<li>might not expect;</li>
<li>might expect but still be a bit ashamed of;</li>
<li>might be interested by.</li>
</ul>
<p>The app quickly run into limitations due to the nature of how I selected the images, lack of any statistical methods implemented to actually present results.</p>
<p>The categories are very broad and non descriptive. For example, &quot;nature&quot; can range from a photo of a river valley, to stuff that is more like two color abstract painting. I prefered the latter, so to interpret results more meaningfully, I'd have to find better ways to categorise / describe the images.</p>
<p>I had these search terms / categories in the test:</p>
<pre class="language-js"><code class="language-js">	<span class="token string-property property">"categories"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token string">"animals"</span><span class="token punctuation">,</span>
		<span class="token string">"architecture"</span><span class="token punctuation">,</span>
		<span class="token string">"cars"</span><span class="token punctuation">,</span>
		<span class="token string">"fashion"</span><span class="token punctuation">,</span>
		<span class="token string">"man"</span><span class="token punctuation">,</span>
		<span class="token string">"motorbikes"</span><span class="token punctuation">,</span>
		<span class="token string">"nature"</span><span class="token punctuation">,</span>
		<span class="token string">"sports"</span><span class="token punctuation">,</span>
		<span class="token string">"street"</span><span class="token punctuation">,</span>
		<span class="token string">"underwater"</span><span class="token punctuation">,</span>
		<span class="token string">"woman"</span>
	<span class="token punctuation">]</span></code></pre>
<p>Roughly, the top 5 images mostly tended to include a variation of <code>[nature, motorbikes, underwater, woman, fashion]</code>.</p>
<p>I am a ±30 year old male, enjoying enduro motorcycling, so it's all very expected.  However, this is still very interesting stuff, and for my next experiment I might update the tracker, build it into a chrome plugin so I could check the view duration of any web content. Then I could track facebook feeds etc.</p>
<p>Also, I noticed I start scrolling faster when I get bored, and &quot;preferred images in the end of session&quot; get less view time than they would have gotten if they were seen in the beginning of the session.</p>
<p>And these feeds are not only photos, it contains political stuff etc. For now, the results are best shown in a video, so enjoy:</p>
<h3>Improvements to be made in next iteration, should there be one.</h3>
<ul>
<li>add categories below images in Dashboard;</li>
<li>save the data of each session in localStorage and build a statistical dashboard to better interpret results;</li>
<li>look for ways to adjust for increasing scroll speed as the session progresses.</li>
</ul>
<p>Check the full code on <a href="https://github.com/Gonusi/in-browser-view-duration-tracking-using-intersection-observer">Github</a> or<a href="https://codesandbox.io/s/in-browser-feed-item-view-duration-tracking-using-intersection-observer-zxgi7?file=/src/components/ViewDurationTracker/ViewDurationTracker.jsx:0-1643%5D">codesandbox</a>.</p>
<p>Bye for now, have a great day.
Kasparas</p>
</div>
			</main>
			<footer class="footer">
				<div class="about">
					<div><strong>Kasparas Anusauskas</strong></div>
					<a href="https://www.linkedin.com/in/kasparas-anusauskas">LinkedIn</a>
				</div>
			</footer>
		</div>
		<!-- <div class="cookieBanner hidden"><div>Please note I'm using Google Analytics. This means this website is using all of the evil cookies you hear about. Only continue browsing if you're OK with that.</div> <button>I understand</button></div> -->
	</body>
</html>
