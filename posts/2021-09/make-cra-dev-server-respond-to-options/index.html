<html>
	<head>
		<link href="/css/main.css" rel="stylesheet" />
		<link href="/css/prism-theme-retro.css" rel="stylesheet" />
		<title>Make CRA dev server respond to CORS OPTIONS requests, as a gentleman should Â· TODO</title>
		<meta name="description" content="Create React App allows you to configure a proxy server, modifying responses it makes. This can be useful for a lot of things, we'll use it to set up cross origin communication between two CRA apps running on same machine, different local domains." />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,700;0,900;1,400;1,700&family=Lora:ital,wght@0,400;0,500;1,400;1,500&display=swap"
			rel="stylesheet"
		/>
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-115C9Z6LKN"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());

			gtag("config", "G-115C9Z6LKN");
		</script>
	</head>
	<body>
		<div class="wrapper">
			<header class="header">
				<div class="blogInfo">
					<div class="logo">Kasparas Anusauskas</div>
					<div class="about">Personal development notes and experiments</div>
				</div>
				<nav class="nav">
					<ul class="navList">
						<li>
							<a href="/"> Home </a>
						</li>
						<li>
							<a href="/about">About</a>
						</li>
					</ul>
				</nav>
			</header>
			<main class="content">
				<h1>Make CRA dev server respond to CORS OPTIONS requests, as a gentleman should</h1>
				<p>If you have ever wished to access the dev server of Create React App, your'e in luck. While working on a login page for a custom authorization server, I needed our OAuth client (SPA app) to return <code>204 OK</code> response with correct CORS headers even in development mode. Essentially, I wanted two CRA apps running on different ports to be able to talk to each other using cross origin POST requests.</p>
<p>Development server (also based on CRA) with login page running @ https://login.app:3000:</p>
<pre class="language-text"><code class="language-text">POST `https://client.app:3001/login-callback?code=123?state=456`</code></pre>
<p>Client App must respond:</p>
<pre class="language-text"><code class="language-text">204 OK<br>#CORS headers (regular ones ommited for briefness): <br>{<br>    # allow login app to make cross origin POST request to me<br>    Access-Control-Allow-Origin: https://login.app:3000 <br>    # allow login app to send me cookies on a cross origin request<br>    Access-Control-Allow-Credentials: true <br>    # allow login app to use these methods on a cross origin request<br>    Access-Control-Allow-Methods: GET, POST<br>}<br></code></pre>
<p>Fortunately, if you put a file <code>setupProxy.js</code> in your <code>src</code> directory (as generated by CRA), you can configure a node express proxy server, modifying responses made by CRA dev server at your own will. Let's use a popular (CORS)[https://www.npmjs.com/package/cors] middleware npm module to set up cross origin responses automatically.</p>
<p>So, using Create React App gives you a similar directory structure (as of 2021). Create the file as shown below:</p>
<pre class="language-text"><code class="language-text"><span class="highlight-line">my-app/</span><br><span class="highlight-line">  README.md</span><br><span class="highlight-line">  node_modules/</span><br><span class="highlight-line">  package.json</span><br><span class="highlight-line">  public/</span><br><span class="highlight-line">    index.html</span><br><span class="highlight-line">    favicon.ico</span><br><span class="highlight-line">  src/</span><br><span class="highlight-line">    App.css</span><br><span class="highlight-line">    App.js</span><br><span class="highlight-line">    App.test.js</span><br><span class="highlight-line">    index.css</span><br><span class="highlight-line">    index.js</span><br><span class="highlight-line">    logo.svg</span><br><mark class="highlight-line highlight-line-active">    setupProxy.js <--- Create this file</mark></code></pre>
<p>File contents should be:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// src/setupProxy.js</span><br><span class="token comment">// do npm install --save-dev cors to install the cors package</span><br><br><span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cors'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> corsOptions <span class="token operator">=</span> <span class="token punctuation">{</span><br>	origin<span class="token operator">:</span> <span class="token string">'https://login.app:3000'</span><span class="token punctuation">,</span><br>	credentials<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>    methods<span class="token operator">:</span> <span class="token string">"GET,POST"</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span>corsOptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	app<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token function">cors</span><span class="token punctuation">(</span>corsOptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br></code></pre>
<p>And that's it. You'll get the response you need. To recap what we have done:</p>
<ul>
<li>configured node express server running (or proxying?) our CRA app on local domain https://client.app:3001;</li>
<li>when it receives OPTIONS request, it will respond with certain headers (specified above);</li>
<li>when browser running App https://login.app:3000 makes that OPTIONS request, specified response headers inform it it's OK to continue with the actual POST request;</li>
<li>everything works out nicely.</li>
</ul>
<p>Actually, we could avoid using any imported package at all. We could just create a little middleware ourselves:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// src/setupProxy.js</span><br>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        res<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'https://login.app:3000'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        res<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">,</span> <span class="token string">'GET,POST'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        res<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>So that's it. This is great stuff, and you can definitely do more than set up CORS with it. FIY, I do not know if this is really a proxy server sitting in between CRA dev server and you, or are we actually configuring the instance of dev server. CRA says we indeed are configuring the dev server instance.</p>
<p>Further reading:</p>
<ul>
<li><a href="https://create-react-app.dev/docs/proxying-api-requests-in-development/">official CRA website on setupProxy</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS on MDN</a></li>
</ul>
<p>Have a great day, reader. End.</p>

			</main>
			<footer class="footer">
				<div class="about">
					<div><strong>Kasparas Anusauskas</strong></div>
					<a href="https://www.linkedin.com/in/kasparas-anusauskas">LinkedIn</a>
				</div>
			</footer>
		</div>
		<!-- <div class="cookieBanner hidden"><div>Please note I'm using Google Analytics. This means this website is using all of the evil cookies you hear about. Only continue browsing if you're OK with that.</div> <button>I understand</button></div> -->
	</body>
</html>
